{% extends 'inquiry/inquiry_base.html' %}
{% block title %}Placement Table {% endblock %}
{% block activeptable %}200{% endblock %}
{% block css %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<style>
    .custom-flex {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 10px;
    }
    .compact-table th, .compact-table td {
        padding: 5px;
    }
    .table-container {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    .table-wrapper {
        width: 70%;
    }
    /* Notification Box Styles */
.notification-box {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    font-size: 14px;
    z-index: 1000;
    display: none;
    border: 2px solid #28a745;
}

.notification-box.show {
    display: block;
}

.notification-box.hidden {
    display: none;
}

</style>
{% endblock %}
{% block body %}

<div class="">
    <div class="table-container">
        <div class="table-wrapper">
            <div class="custom-flex">
                <div>
                    <h2 class="text-xl font-bold">Inquiries</h2>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                        Merge
                    </button>
                    {% include 'inquiry/modal_confirm.html' %}
                </div>
                {% include 'inquiry/search.html' %}
            </div>
            <div class="overflow-x-auto">
                <table class="table-auto min-w-full divide-y divide-gray-200 compact-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="select-all-left">
                            </th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inquiry ID</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DO_BE_PO_NO</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Qty</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination Address</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for inq in inquiries %}
                      
                        <tr>
                            <td class="px-2 py-1 whitespace-nowrap">
                                <input type="checkbox" class="select-row-left" value="{{ inq.inquiry_id }}">
                            </td>
                            <td class="px-2 py-1 whitespace-nowrap">{{ inq.inquiry_id }}</td>
                            <td class="px-2 py-1 whitespace-nowrap">{{ inq.customer.all|join:", " }}</td>
                            <td class="px-2 py-1 whitespace-nowrap">{{ inq.DO_BE_PO_NO }}</td>
                            <td class="px-2 py-1 whitespace-nowrap">{{ inq.order_quantity.all|join:", " }}</td>
                            <td class="px-6 py-4 whitespace-nowrap" data-address-id="{{ inq.destination_address.all|join:', ' }}">{{ inq.destination_address.all|join:", " }}</td>
                        </tr>
                      
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="table-wrapper">
            <div class="custom-flex">
                <h2 class="text-xl font-bold">Transporter List</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="table-auto min-w-full divide-y divide-gray-200 compact-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Expand
                            </th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dummy ID</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr class="parent-row bg-gray-100">
                            <td class="px-2 py-1 whitespace-nowrap cursor-pointer toggle-row">▶</td>
                            <td class="px-2 py-1 whitespace-nowrap">1</td>
                            <td class="px-2 py-1 whitespace-nowrap">Parent 1</td>
                            <td class="px-2 py-1 whitespace-nowrap">Value 1</td>
                        </tr>
                        <tr class="child-row hidden bg-gray-50">
                            <td class="px-2 py-1 whitespace-nowrap"></td>
                            <td class="px-2 py-1 whitespace-nowrap">1.1</td>
                            <td class="px-2 py-1 whitespace-nowrap">Child 1.1</td>
                            <td class="px-2 py-1 whitespace-nowrap">Value 1.1</td>
                        </tr>
                        <tr class="child-row hidden bg-gray-50">
                            <td class="px-2 py-1 whitespace-nowrap"></td>
                            <td class="px-2 py-1 whitespace-nowrap">1.2</td>
                            <td class="px-2 py-1 whitespace-nowrap">Child 1.2</td>
                            <td class="px-2 py-1 whitespace-nowrap">Value 1.2</td>
                        </tr>
                        <!-- More parent-child rows here -->
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
</div>
<!-- Notification Box -->
<div id="notification-box" class="notification-box hidden">
    Merge successful!
</div>

{% endblock %}
{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
    // Search functionality for the left table
    function setupSearchFunctionality() {
        $('#search-dropdown').on('keyup', function() {
            var searchText = $(this).val().toLowerCase();
            $('tbody tr').filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(searchText) > -1);
            });
        });
    }

    // Dropdown filtering for the left table
    function setupDropdownFiltering() {
        $('#dropdown').on('change', 'input[type="checkbox"]', function() {
            var selectedDestinations = $('#dropdown input[type="checkbox"]:checked').map(function() {
                return $(this).val();
            }).get();

            if (selectedDestinations.length > 0) {
                $('tbody tr').hide();
                $('tbody tr').each(function() {
                    var destinationAddressIds = $(this).find('td[data-address-id]').map(function() {
                        return $(this).data('address-id').toString();
                    }).get();
                    if (destinationAddressIds.some(id => selectedDestinations.includes(id))) {
                        $(this).show();
                    }
                });
            } else {
                $('tbody tr').show();
            }
        });
    }

    // Calculate total order quantity
    function calculateTotalOrderQuantity() {
        var totalOrderQuantity = 0;
        $('.select-row-left:checked').each(function() {
            totalOrderQuantity += parseFloat($(this).closest('tr').find('td:nth-child(5)').text()) || 0;
        });
        return totalOrderQuantity;
    }

    // Get selected inquiry IDs
    function getSelectedInquiryIds() {
        var selectedIds = [];
        $('.select-row-left:checked').each(function() {
            selectedIds.push($(this).val());
        });
        return selectedIds;
    }

    // Update modal content before showing it
    function setupModalUpdate() {
        $('#staticBackdrop').on('show.bs.modal', function(event) {
            var totalOrderQuantity = calculateTotalOrderQuantity();
            var selectedInquiryIds = getSelectedInquiryIds();
            
            if (selectedInquiryIds.length === 0) {
                $('#notification-box').text('No inquiries selected').addClass('show grey').removeClass('hidden');
            } else {
                $('#notification-box').text('').removeClass('show grey').addClass('hidden');
                $('#total-order-quantity').text(totalOrderQuantity);
                $('#selected-inquiry-ids').val(selectedInquiryIds.join(','));

                console.log('Total Order Quantity:', totalOrderQuantity);
                console.log('Selected Inquiry IDs:', selectedInquiryIds);
            }
        });
    }

    // Show notification box
    function showNotification(message) {
        var $notificationBox = $('#notification-box');
        $notificationBox.text(message).addClass('show').removeClass('hidden');

        setTimeout(function() {
            $notificationBox.removeClass('show').addClass('hidden');
        }, 3000);
    }

    // Handle form submission for merging inquiries
    function setupFormSubmission() {
        $('#merge-form').on('submit', function(event) {
            event.preventDefault();

            var formData = $(this).serialize();
            console.log('Form Data:', formData);
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: formData,
                success: function(response) {
                    console.log('Response:', response);

                    // Reload the page
                    location.reload();

                    // Close the modal
                    var modal = bootstrap.Modal.getInstance(document.getElementById('staticBackdrop'));
                    modal.hide();

                    // Show notification box after the page reloads
                    showNotification('Merge successful!');
                },
                error: function(xhr, status, error) {
                    console.error('Error:', xhr.responseText);
                    alert('An error occurred while merging inquiries.');
                }
            });
        });
    }

    // Toggle child rows in dummy table
    function setupParentChildToggle() {
        $('.table-auto').on('click', '.toggle-row', function() {
            var $parentRow = $(this).closest('tr');
            var $childRows = $parentRow.nextUntil('.parent-row');

            if ($(this).text() === '▶') {
                $(this).text('▼');
                $childRows.show();
            } else {
                $(this).text('▶');
                $childRows.hide();
            }
        });
    }

    // Select/deselect all checkboxes in dummy table
    function setupSelectAllDummy() {
        $('#select-all-dummy').on('change', function() {
            $('.select-row-dummy').prop('checked', $(this).prop('checked'));
        });
    }

    // Initialize all functionalities
    function initialize() {
        setupSearchFunctionality();
        setupDropdownFiltering();
        setupModalUpdate();
        setupFormSubmission();
        setupParentChildToggle();
        setupSelectAllDummy();
    }

    // Call the initialize function to set up all functionalities
    initialize();
});


</script>

{% endblock %}
